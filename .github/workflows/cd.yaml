name: Bedrock Service CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check kubectl connection
      run: |
        kubectl cluster-info --request-timeout=10s
        echo "âœ… Kubernetes connection verified"
    
    - name: Create AWS Secrets
      run: |
        echo "ğŸ” Creating AWS secrets..."
        
        # Create AWS secrets using organization secrets
        cat <<EOF | kubectl apply -f -
        apiVersion: v1
        kind: Secret
        metadata:
          name: app-secrets
          namespace: bedrock-chat-v2
        type: Opaque
        stringData:
          AWS_ACCESS_KEY_ID: "${{ secrets.AWS_ACCESS_KEY_ID }}"
          AWS_SECRET_ACCESS_KEY: "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          AWS_REGION: "us-east-1"
        EOF
        
        echo "âœ… AWS secrets created"
    
    - name: Create Bedrock Service Deployment
      run: |
        e
      
    
    - name: Apply other Kubernetes manifests
      run: |
        echo "ğŸ“¦ Applying other Bedrock Service manifests..."
        
        # Apply other service resources
        kubectl apply -f k8s/secrets.yaml
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
        kubectl apply -f k8s/hpa.yaml
        kubectl apply -f k8s/network-policies.yaml
        
        echo "âœ… All other Kubernetes manifests applied"
    
    - name: Verify deployment
      run: |
        echo "ğŸ” Verifying bedrock service deployment..."
        
        # Check secrets
        kubectl get secret -n bedrock-chat-v2 app-secrets
        
        # Check pod status
        kubectl get pods -n bedrock-chat-v2 -l app=bedrock-service
        
        # Check service
        kubectl get svc -n bedrock-chat-v2 bedrock-service
        
        # Check HPA
        kubectl get hpa -n bedrock-chat-v2 bedrock-service-hpa
        
        echo "âœ… Bedrock service deployment verification completed"
    
    - name: Deployment Summary
      run: |
        echo "ğŸ‰ Bedrock Service CD Pipeline completed successfully!"
        echo "ğŸ“‹ Deployment Summary:"
        echo "   Namespace: bedrock-chat-v2"
        echo "   Commit: ${{ github.sha }}"
        echo "   AWS Integration: Configured with organization secrets"
        
        # Get final status
        kubectl get all -n bedrock-chat-v2 -l app=bedrock-service
