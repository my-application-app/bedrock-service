name: Bedrock Service CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check kubectl connection
      run: |
        kubectl cluster-info --request-timeout=10s
        echo "✅ Kubernetes connection verified"
    
    - name: Create AWS Secrets
      run: |
        echo "🔐 Creating AWS secrets..."
        
        # Create AWS secrets using organization secrets
        cat <<EOF | kubectl apply -f -
        apiVersion: v1
        kind: Secret
        metadata:
          name: app-secrets
          namespace: bedrock-chat-v2
        type: Opaque
        stringData:
          AWS_ACCESS_KEY_ID: "${{ secrets.AWS_ACCESS_KEY_ID }}"
          AWS_SECRET_ACCESS_KEY: "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          AWS_REGION: "us-east-1"
        EOF
        
        echo "✅ AWS secrets created"
    
    - name: Create Bedrock Service Deployment
      run: |
        echo "📦 Creating Bedrock Service deployment..."
        
        # Create the deployment inline since k8s/deployment.yaml is for api-gateway
        cat <<EOF | kubectl apply -f -
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: bedrock-service
          namespace: bedrock-chat-v2
          labels:
            app: bedrock-service
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: bedrock-service
          template:
            metadata:
              labels:
                app: bedrock-service
            spec:
              imagePullSecrets:
                - name: docker-hub-secret
              containers:
                - name: bedrock-service
                  image: samitsinghhh/bedrock-service:v3
                  imagePullPolicy: Always
                  ports:
                    - containerPort: 9000
                      name: http
                  env:
                    - name: AWS_ACCESS_KEY_ID
                      valueFrom:
                        secretKeyRef:
                          name: app-secrets
                          key: AWS_ACCESS_KEY_ID
                    - name: AWS_SECRET_ACCESS_KEY
                      valueFrom:
                        secretKeyRef:
                          name: app-secrets
                          key: AWS_SECRET_ACCESS_KEY
                    - name: AWS_REGION
                      valueFrom:
                        secretKeyRef:
                          name: app-secrets
                          key: AWS_REGION
                  startupProbe:
                    httpGet:
                      path: /health
                      port: 9000
                    initialDelaySeconds: 20
                    periodSeconds: 5
                    timeoutSeconds: 3
                    successThreshold: 1
                    failureThreshold: 12
                  livenessProbe:
                    httpGet:
                      path: /health
                      port: 9000
                    initialDelaySeconds: 45
                    periodSeconds: 15
                    timeoutSeconds: 5
                    successThreshold: 1
                    failureThreshold: 3
                  readinessProbe:
                    httpGet:
                      path: /health
                      port: 9000
                    initialDelaySeconds: 30
                    periodSeconds: 10
                    timeoutSeconds: 5
                    successThreshold: 1
                    failureThreshold: 3
                  resources:
                    requests:
                      memory: "64Mi"
                      cpu: "50m"
                    limits:
                      memory: "256Mi"
                      cpu: "500m"
        EOF
        
        echo "✅ Bedrock service deployment created"
    
    - name: Apply other Kubernetes manifests
      run: |
        echo "📦 Applying other Bedrock Service manifests..."
        
        # Apply other service resources
        kubectl apply -f k8s/service.yaml
        kubectl apply -f k8s/hpa.yaml
        kubectl apply -f k8s/network-policies.yaml
        
        echo "✅ All other Kubernetes manifests applied"
    
    - name: Verify deployment
      run: |
        echo "🔍 Verifying bedrock service deployment..."
        
        # Check secrets
        kubectl get secret -n bedrock-chat-v2 app-secrets
        
        # Check pod status
        kubectl get pods -n bedrock-chat-v2 -l app=bedrock-service
        
        # Check service
        kubectl get svc -n bedrock-chat-v2 bedrock-service
        
        # Check HPA
        kubectl get hpa -n bedrock-chat-v2 bedrock-service-hpa
        
        echo "✅ Bedrock service deployment verification completed"
    
    - name: Deployment Summary
      run: |
        echo "🎉 Bedrock Service CD Pipeline completed successfully!"
        echo "📋 Deployment Summary:"
        echo "   Namespace: bedrock-chat-v2"
        echo "   Commit: ${{ github.sha }}"
        echo "   AWS Integration: Configured with organization secrets"
        
        # Get final status
        kubectl get all -n bedrock-chat-v2 -l app=bedrock-service
